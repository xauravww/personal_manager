// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String
  name          String
  created_at    DateTime @default(now()) @map("created_at")
  updated_at    DateTime @updatedAt @map("updated_at")

   // Relations
   resources Resource[]
   tags      Tag[]
   learningSubjects LearningSubject[]
   learningProgress LearningProgress[]
   assignmentSubmissions AssignmentSubmission[]
   weakPoints WeakPoint[]
   mindmaps MindMap[]
   learningDNA UserLearningDNA?
   searchLogs SearchLog[]
   conversations Conversation[]
   knowledgeConnections KnowledgeConnection[]

  @@map("users")
}

model Conversation {
  id          String    @id @default(uuid())
  user_id     String
  title       String    @default("New Chat")
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("conversations")
}

model Message {
  id              String       @id @default(uuid())
  conversation_id String
  role            String       // "user" or "assistant"
  content         String
  created_at      DateTime     @default(now()) @map("created_at")
  
  // Metadata for AI responses
  citations       String?      // JSON string of citations
  suggestions     String?      // JSON string of suggestions
  
  // Relations
  conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Resource {
  id          String   @id @default(uuid())
  user_id     String
  title       String
  description String?
  url         String?
  type        ResourceType
  content     String?
  file_path   String?
  metadata    Json?
  embedding   String?  // JSON string of embedding array
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  user   User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  tags   Tag[]    @relation("ResourceTags")

  @@map("resources")
}

model Tag {
  id         String   @id @default(uuid())
  user_id    String
  name       String
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  user      User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  resources Resource[] @relation("ResourceTags")

  @@unique([user_id, name])
  @@map("tags")
}

enum ResourceType {
  note
  video
  link
  document
}

model LearningSubject {
  id          String   @id @default(uuid())
  user_id     String
  name        String   // e.g., "Python", "Machine Learning"
  description String?
  current_level String? // "beginner", "intermediate", "advanced"
  goals       String?  // JSON string of learning goals
  estimated_hours Int?
  is_active   Boolean  @default(true)
  embedding   String?  // Vector embedding for semantic search
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  user     User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  modules  LearningModule[]
  progress LearningProgress[]
  weakPoints WeakPoint[]
  mindmaps MindMap[]

  @@map("learning_subjects")
}

model LearningModule {
  id            String   @id @default(uuid())
  subject_id    String
  title         String
  description   String?
  content       String?  // Module content or instructions
  order_index   Int      @default(0)
  prerequisites String?  // JSON array of prerequisite module IDs
  estimated_time Int?    // in minutes
  difficulty    String?  // "easy", "medium", "hard"
  is_optional   Boolean  @default(false)
  checkpoints   String?  // JSON array of sub-topics/checkpoints
  embedding     String?  // Vector embedding for semantic search
  created_at    DateTime @default(now()) @map("created_at")
  updated_at    DateTime @updatedAt @map("updated_at")

  // Relations
  subject  LearningSubject  @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  progress LearningProgress[]
  assignments Assignment[]

  @@map("learning_modules")
}

model LearningProgress {
  id         String   @id @default(uuid())
  user_id    String
  subject_id String
  module_id  String
  status     String   @default("not_started") // "not_started", "in_progress", "completed"
  score      Float?   // percentage score for assignments
  time_spent Int      @default(0) // in minutes
  started_at DateTime?
  completed_at DateTime?
  notes      String?  // user notes or reflections
  checkpoints_progress String? // JSON array tracking status of each checkpoint
  
  // Personalized learning data for review and AI analysis
  chat_history String? // Full conversation history (JSON)
  quiz_attempts String? // Quiz questions, answers, correctness (JSON)
  identified_weaknesses String? // Areas where user struggled (JSON)
  code_snippets String? // Code written by user (JSON)
  key_learnings String? // AI-generated summary of what user learned (JSON)
  
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user    User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subject LearningSubject @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  module  LearningModule  @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([user_id, module_id])
  @@map("learning_progress")
}

model Assignment {
  id          String    @id @default(uuid())
  module_id   String
  title       String
  description String?
  type        String    @default("exercise") // "quiz", "exercise", "project", "code_challenge", "file_upload", "structured", "chat_guided", "hybrid"
  content     String?   // assignment content or questions
  solution    String?   // correct solution or rubric
  max_score   Float     @default(100)
  time_limit  Int?      // in minutes
  due_date    DateTime? // assignment due date
  is_required Boolean   @default(true)
  steps       String?   // JSON array of assignment steps for structured assignments
  ai_config   String?   // JSON AI configuration for adaptive assignments
  modalities  String?   // JSON array of supported modalities ["text", "interactive"]
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @updatedAt @map("updated_at")

  // Relations
  module      LearningModule @relation(fields: [module_id], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@map("assignments")
}

model AssignmentSubmission {
  id            String   @id @default(uuid())
  assignment_id String
  user_id       String
  content       String   // user's submission
  score         Float?   // AI-assigned score
  feedback      String?  // AI-generated feedback
  weak_points   String?  // JSON array of identified weak points
  steps_progress String? // JSON array of step-by-step progress for structured assignments
  submitted_at  DateTime @default(now())
  graded_at     DateTime?

  // Relations
  assignment Assignment @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("assignment_submissions")
}

model WeakPoint {
  id          String   @id @default(uuid())
  user_id     String
  subject_id  String?
  topic       String   // e.g., "error handling", "regex", "async programming"
  description String?
  frequency   Int      @default(1) // how many times identified
  severity    String   @default("medium") // "low", "medium", "high"
  suggestions String?  // JSON array of improvement suggestions
  last_identified DateTime @default(now())
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  user    User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subject LearningSubject? @relation(fields: [subject_id], references: [id], onDelete: Cascade)

  @@unique([user_id, topic])
  @@map("weak_points")
}

model MindMap {
  id         String   @id @default(uuid())
  user_id    String
  subject_id String?
  title      String
  content    String   // JSON structure of the mindmap
  type       String   @default("concept") // "concept", "progress", "weak_points"
  generated_at DateTime @default(now())
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user    User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subject LearningSubject? @relation(fields: [subject_id], references: [id], onDelete: Cascade)

  @@map("mindmaps")
}

model UserLearningDNA {
  id                    String   @id @default(uuid())
  user_id               String   @unique
  learning_dna          String   // JSON learning profile
  last_updated          DateTime @updatedAt
  created_at            DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_learning_dna")
}

model SearchLog {
  id          String   @id @default(uuid())
  user_id     String
  query       String
  filters     String?  // JSON string of applied filters
  result_count Int     @default(0)
  search_type String   @default("basic") // "basic", "deep_research", "web_search"
  created_at  DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("search_logs")
}

model KnowledgeConnection {
  id          String   @id @default(uuid())
  user_id     String
  source_id   String   // ID of source node
  source_type String   // "subject", "module", "resource", "note"
  target_id   String   // ID of target node
  target_type String   // "subject", "module", "resource", "note"
  strength    Float    // 0-1 similarity score
  type        String   // "semantic", "prerequisite", "related", "user_defined"
  created_at  DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, source_id, source_type, target_id, target_type])
  @@map("knowledge_connections")
}